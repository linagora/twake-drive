services:
  mongo:
    image: mongo
    healthcheck:
      test: echo 'db.runCommand("ping").ok' | mongosh localhost:27017/test --quiet
      interval: 2m
      timeout: 2m
      retries: 30
      start_period: 10s
      start_interval: 3s
    ports:
      - 27017:27017
  av:
    image: clamav/clamav:latest
    platform: linux/x86_64 # This image doesn't support apple silicon "linux/arm64/v8"
    ports:
      - 3310:3310
    healthcheck:
      test: ["CMD-SHELL", "echo 'PING' | nc -w 5 localhost 3310"]
      interval: 30s
      timeout: 10s
      retries: 5

  onlyoffice:
    image: docker.io/onlyoffice/documentserver
    ports:
      - 8090:80
    healthcheck:
      test: curl --fail 'http://localhost/healthcheck'
    environment:
      - JWT_ENABLED=false
      - ALLOW_META_IP_ADDRESS=true
      - ALLOW_PRIVATE_IP_ADDRESS=true
    extra_hosts:
      - "host.docker.internal:host-gateway"

  onlyoffice-connector:
    build:
      context: .
      dockerfile: docker/onlyoffice-connector/Dockerfile
    environment:
      - CREDENTIALS_ENDPOINT=http://node:4000
      - ONLY_OFFICE_SERVER=http://localhost:8090/
      - SERVER_ORIGIN=http://localhost:5000
      - SERVER_PORT=5000
      - SERVER_PREFIX=/plugins/onlyoffice
      - CREDENTIALS_ID=tdrive_onlyoffice
      - CREDENTIALS_SECRET=c1cc66db78e1d3bb4713c55d5ab2
    ports:
      - 5000:5000
    depends_on:
      onlyoffice:
        condition: service_healthy
    # extra_hosts:
    #   - "onlyoffice-connector.local:host.docker.internal"

  node_create_user:
    build: &backend_docker_build
      context: .
      dockerfile: docker/tdrive-node/Dockerfile
      # target: development
      target: production
    environment: &backend_env_vars
      DEV: dev
      ACCOUNTS_TYPE: internal
      DB_DRIVER: mongodb
      DB_MONGO_URI: mongodb://mongo:27017
      PUBSUB_TYPE: local
      SEARCH_DRIVER: mongodb
      STORAGE_DRIVER: local
      STORAGE_LOCAL_PATH: /tmp/td  
    command: /usr/src/app/bin/twake-cli dev set_local_user a@b.com aaaaaaaa
    depends_on: &backend_dependencies
      mongo:
        condition: service_healthy
  
  node:
    build: *backend_docker_build
    ports:
      - 4000:4000
      - 9229:9229
    environment:
      <<: *backend_env_vars
      ENABLE_FEATURE_ANTIVIRUS: true
      DIAG_PROBE_SECRET: diag-secret
      APPLICATIONS: |-
        {
          "grid": [
            {
              "name": "Chat",
              "logo": "/public/img/grid/twake.svg",
              "url": "https://web.twake.app/"
            },
            {
              "name": "Mail",
              "logo": "/public/img/grid/mail.svg",
              "url": "https://tmail.linagora.com/"
            },
            {
              "name": "Drive",
              "logo": "/public/img/grid/drive.svg",
              "url": "https://tdrive.qa.lin-saas.com/"
            },
            {
              "name": "Calendar",
              "logo": "/public/img/grid/calendar.svg",
              "url": "https://openpaas.linagora.com/calendar/"
            },
            {
              "name": "Contacts",
              "logo": "/public/img/grid/contacts.svg",
              "url": "https://openpaas.linagora.com/contacts"
            },
            {
              "name": "Visio",
              "logo": "/public/img/grid/visio.svg",
              "url": "https://jitsi.linagora.com/"
            }
          ],
          "plugins": [
            {
              "api": {
                "private_key": "c1cc66db78e1d3bb4713c55d5ab2"
              },
              "display": {
                "tdrive": {
                  "files": {
                    "editor": {
                      "edition_url": "http://localhost:5000/plugins/onlyoffice/",
                      "empty_files": [
                        {
                          "filename": "Untitled.docx",
                          "name": "ONLYOFFICE Word Document",
                          "url": "/plugins/onlyoffice/assets/empty.docx"
                        },
                        {
                          "filename": "Untitled.xlsx",
                          "name": "ONLYOFFICE Excel Document",
                          "url": "/plugins/onlyoffice/assets/empty.xlsx"
                        },
                        {
                          "filename": "Untitled.pptx",
                          "name": "ONLYOFFICE PowerPoint Document",
                          "url": "/plugins/onlyoffice/assets/empty.pptx"
                        }
                      ],
                      "extensions": [
                        "xlsx",
                        "pptx",
                        "docx",
                        "xls",
                        "ppt",
                        "doc",
                        "odt",
                        "ods",
                        "odp",
                        "txt",
                        "html",
                        "csv"
                      ],
                      "preview_url": "http://localhost:5000/plugins/onlyoffice/?preview=1"
                    }
                  },
                  "version": 1
                }
              },
              "external_prefix": "/plugins/onlyoffice/",
              "id": "tdrive_onlyoffice",
              "identity": {
                "categories": [],
                "code": "only_office",
                "compatibility": ["tdrive"],
                "description": null,
                "icon": "/plugins/onlyoffice/assets/logo.png",
                "name": "Only Office",
                "website": "http://twake.app/"
              },
              "internal_domain": "http://localhost:5000/"
            }
          ]
        }
    healthcheck:
      test: curl --fail 'http://localhost:4000/diagnostics/t/ready?secret=diag-secret'
    depends_on:
      <<: *backend_dependencies
      node_create_user:
        condition: service_completed_successfully
      av:
        condition: service_healthy
      onlyoffice:
        condition: service_healthy
  
  frontend:
    build:
      context: .
      dockerfile: docker/tdrive-frontend/Dockerfile
    container_name: tdrive-frontend
    environment:
      - DEV=production
      - SSL_CERTS=off
      - NODE_HOST=http://node:4000
    ports:
      - 80:80
    depends_on:
      node:
        condition: service_healthy
